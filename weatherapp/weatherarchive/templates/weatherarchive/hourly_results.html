{% extends 'weatherarchive/base.html' %}
{% block title %}Hourly Weather • Weather Archive{% endblock %}
{% block content %}
<section class="card pad">
  <h1>Hourly Weather Archive</h1>
  <p class="muted">Query a range of hourly weather for any location.</p>
  <form method="get" action="">
    <div class="row full">
      {{ form.non_field_errors }}
    </div>
    <div class="row full">
      {{ form.location.label_tag }}
      {{ form.location }}
      {% if form.location.errors %}<div class="error">{{ form.location.errors.0 }}</div>{% endif %}
    </div>
    <div class="row">
      <div>
        {{ form.start_date.label_tag }}
        {{ form.start_date }}
        {% if form.start_date.errors %}<div class="error">{{ form.start_date.errors.0 }}</div>{% endif %}
      </div>
      <div>
        {{ form.end_date.label_tag }}
        {{ form.end_date }}
        {% if form.end_date.errors %}<div class="error">{{ form.end_date.errors.0 }}</div>{% endif %}
      </div>
    </div>
    <div class="actions">
      <button class="btn" type="submit">Search</button>
      {% if has_results %}
        <a class="btn secondary" href="{% url 'weatherarchive:download_hourly_csv' %}?location={{ form.cleaned_data.location }}&start_date={{ form.cleaned_data.start_date }}&end_date={{ form.cleaned_data.end_date }}">Download CSV</a>
      {% endif %}
    </div>
  </form>
</section>

{% if error %}
  <p class="error" style="margin-top:10px">{{ error }}</p>
{% endif %}

{% if has_results %}
  <section style="margin-top:16px" class="card pad">
    <h2 style="margin-top:0">Results for {{ display_name }} ({{ lat }}, {{ lon }})</h2>
    <p class="muted">From {{ start }} to {{ end }}</p>

    <div class="cards">
      <div class="stat"><h4>Temp mean</h4><div class="val">{{ stats.temp.mean|floatformat:2 }}</div></div>
      <div class="stat"><h4>Temp std</h4><div class="val">{{ stats.temp.std|floatformat:2 }}</div></div>
      <div class="stat"><h4>RH mean</h4><div class="val">{{ stats.rh.mean|floatformat:2 }}</div></div>
      <div class="stat"><h4>Wind mean</h4><div class="val">{{ stats.wind.mean|floatformat:2 }}</div></div>
    </div>

    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Temp (°C)</th>
            <th>RH (%)</th>
            <th>Precip (mm)</th>
            <th>Wind (km/h)</th>
            <th>Temp Anom?</th>
          </tr>
        </thead>
        <tbody>
          {% for t, ta, rh, pr, wd, an in rows %}
            <tr>
              <td>{{ t }}</td>
              <td>{{ ta }}</td>
              <td>{{ rh }}</td>
              <td>{{ pr }}</td>
              <td>{{ wd }}</td>
              <td><span class="pill {% if an %}bad{% else %}ok{% endif %}">{% if an %}Yes{% else %}No{% endif %}</span></td>
            </tr>
          {% empty %}
            <tr><td colspan="6">No data available for the selected range.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div id="charts" style="margin-top:16px">
      <div id="chart_temp_hr" class="card plot" style="padding:8px;margin-bottom:12px"></div>
      <div id="chart_precip_hr" class="card plot" style="padding:8px"></div>
    </div>
    {{ times|json_script:"times-data" }}
    {{ temp|json_script:"temp-data" }}
    {{ rh|json_script:"rh-data" }}
    {{ precip|json_script:"precip-data" }}
    {{ wind|json_script:"wind-data" }}
  </section>
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      const times = JSON.parse(document.getElementById('times-data').textContent);
      const temp = JSON.parse(document.getElementById('temp-data').textContent);
      const rh = JSON.parse(document.getElementById('rh-data').textContent);
      const precip = JSON.parse(document.getElementById('precip-data').textContent);
      const wind = JSON.parse(document.getElementById('wind-data').textContent);

      const tData = [
        {x: times, y: temp, type: 'scatter', mode: 'lines', name: 'Temp (°C)', line:{color:'#ff6b6b'}},
        {x: times, y: rh, type: 'scatter', mode: 'lines', name: 'RH (%)', yaxis: 'y2', line:{color:'#4cc9f0'}}
      ];
      const tLayout = {
        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
        font: {color: '#e8eef9'},
        height: 360,
        margin: {l:40, r:40, t:10, b:40},
        xaxis: {title: 'Time', tickangle: -30, gridcolor:'#1f2d4a', automargin: true},
        yaxis: {title: '°C', gridcolor:'#1f2d4a', automargin: true},
        yaxis2: {title: 'RH (%)', overlaying: 'y', side: 'right'}
      };
      Plotly.newPlot('chart_temp_hr', tData, tLayout, {displayModeBar:false, responsive:true});

      const pData = [
        {x: times, y: precip, type: 'bar', name: 'Precip (mm)', marker:{color:'#a1ffce'}},
        {x: times, y: wind, type: 'scatter', mode: 'lines', name: 'Wind (km/h)', yaxis:'y2', line:{color:'#b9ccf0'}}
      ];
      const pLayout = {
        paper_bgcolor: 'rgba(0,0,0,0)', plot_bgcolor: 'rgba(0,0,0,0)',
        font: {color: '#e8eef9'},
        height: 360,
        margin: {l:40, r:40, t:10, b:40},
        xaxis: {title: 'Time', tickangle: -30, gridcolor:'#1f2d4a', automargin: true},
        yaxis: {title: 'Precip (mm)', gridcolor:'#1f2d4a', automargin: true},
        yaxis2: {title: 'Wind (km/h)', overlaying: 'y', side: 'right'}
      };
      Plotly.newPlot('chart_precip_hr', pData, pLayout, {displayModeBar:false, responsive:true});
    });
  </script>
{% endif %}
{% endblock %}
